# Tauri v2 重构接续文档（B-C-D-A）

> 生成时间：2026-02-26 11:43:32  
> 适用对象：下一位接手开发的 AI Agent / 开发者  
> 目标：快速理解“已完成什么、还剩什么、下一步怎么做”

---

## 1. 当前任务总目标

项目正在执行一次**架构升级后的系统性优化/修复/重构**，严格按顺序推进：

**B → C → D → A**

- B：后端并发与状态恢复一致性
- C：前端状态一致性（去乐观更新）
- D：工程治理与可观测性
- A：回归验证与测试补齐

并且：`docs/code_review.md` 中的问题，按约定在主线（B-C-D-A）完成后再统一清理。

---

## 2. 当前进度（已完成）

### 2.1 B 阶段已完成子任务

#### ✅ `b-runtime-lock-split`
核心点：
- 对 `DownloadManager` 的关键 runtime 路径做了锁拆分，缩短写锁持有时间，减少 `await` 跨锁。
- 处理中间编译问题，保证模型字段与当前代码一致。
- 修复 `runtime_start_download` / `runtime_resume_download` 互调引发的异步递归问题（`E0733`）。

结果：
- `cargo check` / `cargo test` 可通过。

---

#### ✅ `b-active-handle-lifecycle`
核心点：
- 新增并接入 `reap_finished_active_downloads`。
- 在任务启动、调度、取消、队列处理等路径主动回收已完成 `JoinHandle`。

结果：
- 避免并发槽位被“假占用”。
- 该批改动已通过编译与测试验证。

---

### 2.2 B 阶段进行中子任务：`b-pause-resume-consistency`

#### ✅ 已落地修复（已完成并验证）
1. **事件回放防回退（`apply_event_side_effects`）**
   - 防止 `TaskPaused` 覆盖终态（Completed/Cancelled/Failed）。
   - 防止 `TaskStarted/TaskResumed` 覆盖暂停态与终态。
   - 增加对“迟到 `TaskPaused`”的防御，避免已恢复任务被误回滚为暂停。

2. **进度单调性（`update_task_progress_snapshot`）**
   - `downloaded_size` 改为单调不减。
   - 增加 `Failed` 的终态保护。
   - 保证进度不超过 `total_size`。

3. **恢复后状态清理（`runtime_resume_download`）**
   - 在激活路径明确清理：
     - `paused_at = None`
     - `paused_from_active = false`

4. **本地断点优先：磁盘与内存对齐（`resume_downloader.rs`）**
   - `sync_chunks_with_temp_files` 不再只处理“磁盘更大”的情况，改为**任何差异都对齐**。
   - 文件缺失/空文件时主动将 chunk 重置为 `Pending`、`downloaded=0`。

5. **单分片 Range 续传正确性**
   - 单 chunk 且已有进度时，强制 Range 请求。
   - 若发起了 Range 但服务端未返回 `206`，立即报错防止脏写/覆盖。

6. **并发分片失败时的进度保全**
   - `download_with_resume` 不再首错即退。
   - 先回收全部分片结果、同步磁盘进度并持久化，再返回错误。
   - 避免“部分成功进度丢失”引发回退。

---

## 3. 当前正在做的事（接手点）

正在进行：`b-pause-resume-consistency` 的**全链路静态复核**（加载状态 → 磁盘对齐 → 分片请求 → 落盘 → 持久化）。

目标：
- 再定位是否仍存在边界条件会导致“本地进度回退/状态抖动”；
- 如发现问题，继续走“最小补丁 + 回归验证”。

重点文件：
- `src-tauri/src/core/resume_downloader.rs`
- `src-tauri/src/core/manager.rs`
- `src-tauri/src/core/models.rs`

---

## 4. 待完成任务（剩余工作）

### 4.1 B 阶段（未完）
- `b-pause-resume-consistency`：收尾与闭环验证（当前进行中）。
- `b-startup-recovery-batch`：冷启动恢复批处理策略与 `paused_from_active` 收口策略。

### 4.2 C 阶段
- `c-store-deoptimistic`：移除前端破坏性乐观更新，改为后端事件确认驱动。

### 4.3 D 阶段
- `d-command-path-observe`：补命令路径观测能力。
- `d-ci-review-loop`：建立 CI 级回归/审查循环。

### 4.4 A 阶段
- `a-regression-matrix`：B-C-D-A 全链路回归矩阵。
- `a-e2e-tests`：关键链路端到端测试补齐。
- `a-docs-regression`：主线完成后对照 `docs/code_review.md` 最终清理。

---

## 5. 风险与阻塞项

1. **计划文件缺失风险**
   - 历史上下文提到 `b-c-d-a_重构修复计划_feb92ce6.plan.md` 当前无法定位（可能被移动/重命名）。
   - 建议：若无法恢复，以本交接文档为临时执行基线继续推进。

2. **工作区较脏**
   - 当前仓库存在大量已有改动与构建产物，提交前需谨慎区分“本次改动”与“历史/无关改动”。

3. **暂停恢复链路天然复杂**
   - 涉及状态机、并发任务、事件乱序、磁盘状态与 HTTP 语义一致性，必须坚持“小步快跑 + 强回归”。

---

## 6. 下一位 AI 的建议执行顺序（可直接照做）

1. 先完成 `B` 收尾，不要跳到 `C/D/A`。  
2. 在 `resume_downloader.rs` 再做一轮边界排查，优先关注：
   - chunk 状态持久化时机；
   - pause/cancel 与并发分片收敛时序；
   - resume_info 与真实文件系统一致性。
3. 每次只做最小补丁，并立即执行：
   - `cargo check -q`
   - `cargo test -q`
4. B 完成后进入 C，再 D，再 A。
5. 主线全部完成后再回到 `docs/code_review.md` 收尾。

---

## 7. 回归命令模板

```bash
# 后端快速验证
cargo check -q
cargo test -q

# 如果改了前端（进入 C 阶段后）
pnpm test
pnpm build
```

> 注：若环境中已有长期运行任务，先确认再执行，避免冲突。

---

## 8. 给下一位 AI 的“接续开发提示词”（可复制）

```text
你现在接手一个 Tauri v2 升级后的重构项目，请严格遵循以下规则执行：

1) 执行顺序必须是 B → C → D → A，不允许跳步。
2) docs/code_review.md 中的问题先不要处理，等 B-C-D-A 主线完成后再统一处理。
3) 当前已完成：
   - b-runtime-lock-split
   - b-active-handle-lifecycle
   - b-pause-resume-consistency 的一部分（事件防回退、进度单调、resume 清理、磁盘优先同步、单chunk Range 206 校验、并发失败进度保全）
4) 当前进行中：b-pause-resume-consistency 收尾（重点是本地断点优先全链路复核）。
5) 你要先从以下文件继续：
   - src-tauri/src/core/resume_downloader.rs
   - src-tauri/src/core/manager.rs
   - src-tauri/src/core/models.rs
6) 工作方式：
   - 只做最小补丁，避免大重构
   - 每次改动后必须跑 cargo check -q && cargo test -q
   - 如果发现不确定行为，先读代码再改，不做猜测
7) B 阶段收尾完成后，按顺序推进：
   - C: 去除前端乐观状态破坏更新，改后端事件确认
   - D: 命令路径观测 + CI review loop
   - A: 回归矩阵 + E2E + docs/code_review.md 收尾
8) 输出要求：
   - 每轮说明“改了什么、为什么、如何验证、风险点”
   - 保持中文输出
```

---

## 9. 快速定位索引

- 后端核心管理器：`src-tauri/src/core/manager.rs`
- 断点续传核心：`src-tauri/src/core/resume_downloader.rs`
- 任务模型：`src-tauri/src/core/models.rs`
- 代码审查清单（后置处理）：`docs/code_review.md`
- 项目总规则：`AGENTS.md`
- 历史对话全文（如需细节追溯）：  
  `C:\Users\admin\.cursor\projects\d-develop-file-7-codex-dev-07-tauri-video-batch-downloader/agent-transcripts/d6f2b4b2-48cb-4a51-8ef7-32d8e45003b8.txt`

---

## 10. 交接结论

当前主线推进健康，B 阶段核心风险点已消除一批，且均经过回归。  
下一步最关键的是：**完成 `b-pause-resume-consistency` 的最后收口**，然后严格进入 C → D → A。

